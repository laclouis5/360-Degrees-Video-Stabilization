clc
clear
close all

%%
path  = 'Images/360degreesImages/canyon.jpg';
image = imread(path);

[hImage, wImage, dImage] = size(image);

t = 1000;
[x, y, z] = sphere(t);

azimuth = 0;
elevation = 0;

ratio = 4/3;

angleW = 60*pi/180;
angleH = angleW/ratio;

theta1 = azimuth - angleW/2;
theta2 = azimuth + angleW/2;

phi1 = elevation - angleH/2;
phi2 = elevation + angleH/2;

d1 = wImage/2/pi;
d2 = hImage/pi;

%%
[theta, phi, r] = cart2sph(x, y, z);

mask = (theta > theta1) & (theta < theta2) & (phi > phi1) & (phi < phi2);

Theta = theta.*mask;
Phi = phi.*mask;
R = r.*mask;

[row, col] = find(R);

[X, Y, Z] = sph2cart(Theta, Phi, R);

H = surf(X, Y, Z);
rotate(H, [0, 1, 0], 90, [0, 0, 0]);
rotate(H, [0, 1, 0], 0, [0, 0, 0]);
axis equal;

X1 = H.XData;
Y1 = H.YData;
Z1 = H.ZData;

[AZ1, EL1, R1] = cart2sph(X1, Y1, Z1);
[AZ3, EL3, R3] = cart2sph(X, Y, Z);

AZ2 = floor(AZ1*d1 + wImage/2);
EL2 = floor(EL1*d2 + hImage/2);

hNewImage = limP2 - limP1 + 1;
wNewImage = limT2 - limT2 + 1;
dNewImage = dImage;

imageF = zeros(hNewImage, wNewImage, dImage);

for i = 1:hNewImage
    for j = 1:wNewImage
        image(EL2(i, j), AZ2(i, j), :) = [255 0 0];
    end
end

figure, imshow(image);        